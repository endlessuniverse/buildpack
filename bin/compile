#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR
#env
#if [ "$CRED" != "" ]; then
#  echo $CRED | base64 --decode > /app/cred.json
#  chmod 400 /app/cred.json
#fi

set -euo pipefail
OLD_PATH="$PATH"

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

echo "-----> Installing Zstandard ..."
tar -zxf dist/zstd.tgz -C "$BUILD_DIR"
cat << "EOF" > "$BUILD_DIR/.profile.d/zstd.sh"
export PATH="$PATH:$HOME/zstd"
EOF
chmod +x "$BUILD_DIR/.profile.d/zstd.sh"

echo "-----> Installing LZ4 ..."
tar -zxf dist/lz4.tgz -C "$BUILD_DIR"
cat << "EOF" > "$BUILD_DIR/.profile.d/lz4.sh"
export PATH="$PATH:$HOME/lz4"
EOF
chmod +x "$BUILD_DIR/.profile.d/lz4.sh"

echo "-----> Installing OpenResty ..."
tar -zxf dist/openresty.tgz -C "$BUILD_DIR"
cp -a conf/nginx.conf.default "$BUILD_DIR/openresty/nginx/conf"
cp -a bin/startopenresty "$BUILD_DIR/openresty/bin"
fold -w 100 -s < "$BUILD_DIR/openresty/openresty-V.txt" | pr -to 7

# Add a profile.d script to add openresty tools and luarocks to PATH
cat << "EOF" > "$BUILD_DIR/.profile.d/000-openresty-path.sh"
export PATH="$PATH:$HOME/openresty/bin:$HOME/openresty/luarocks/bin:$HOME/openresty/luajit/bin:$HOME/openresty/nginx/sbin"
EOF
chmod +x "$BUILD_DIR/.profile.d/000-openresty-path.sh"

ln -s "$BUILD_DIR/openresty" /app/openresty
export PATH="$PATH:/app/openresty/bin:/app/openresty/luarocks/bin:/app/openresty/luajit/bin:/app/openresty/nginx/sbin"

# Install OPM packages from opm.txt
if [[ -f "$BUILD_DIR/opm.txt" ]]; then
  chksum="$(sha1sum "$BUILD_DIR/opm.txt" | awk '{print $1}')"

  if [[ -f "$CACHE_DIR/opm-${chksum}.tar.gz" ]]; then
    echo "-----> Installing cached OPM packages ..."
    tar -zxf "$CACHE_DIR/opm-${chksum}.tar.gz" -C "$BUILD_DIR/openresty/site"
  else
    while read name; do
      echo "-----> Installing OPM package: $name ..."
      opm get "$name" 2>&1 | fold -w 100 -s | pr -to 7
    done < "$BUILD_DIR/opm.txt"

    echo "-----> Caching OPM packages ..."
    tar -zcf "$CACHE_DIR/opm-${chksum}.tar.gz" -C "$BUILD_DIR/openresty/site" .
  fi
fi

# Install LuaRocks packages from luarocks.txt
if [[ -f "$BUILD_DIR/luarocks.txt" ]]; then
  chksum="$(sha1sum "$BUILD_DIR/luarocks.txt" | awk '{print $1}')"

  if [[ -f "$CACHE_DIR/luarocks-${chksum}.tar.gz" ]]; then
    echo "-----> Installing cached LuaRocks packages ..."
    tar -zxf "$CACHE_DIR/luarocks-${chksum}.tar.gz" -C "$BUILD_DIR/openresty/luarocks"
  else
    while read rock version; do
      if [[ "$version" ]]; then
        echo "-----> Installing LuaRocks package: ${rock}@${version} ..."
        luarocks install "$rock" "$version" 2>&1 | fold -w 100 -s | pr -to 7
      else
        echo "-----> Installing LuaRocks package: ${rock}@latest ..."
        luarocks install "$rock" 2>&1 | fold -w 100 -s | pr -to 7
      fi
    done < "$BUILD_DIR/luarocks.txt"

    echo "-----> Caching LuaRocks packages ..."
    tar -zcf "$CACHE_DIR/luarocks-${chksum}.tar.gz" -C "$BUILD_DIR/openresty/luarocks" .
  fi
fi

#if [[ -f "$CACHE_DIR/GeoLite2-Country.tar.gz" ]]; then
#  echo "-----> Installing cached GeoLite2-Country database ..."
#  tar -zxf "$CACHE_DIR/GeoLite2-Country.tar.gz" --wildcards "GeoLite2-Country_*/GeoLite2-Country.mmdb"
#  mv GeoLite2-Country_*/GeoLite2-Country.mmdb "$BUILD_DIR/conf/"
#else
#  if [[ -f $BUILD_DIR/conf/maxmind.key ]]; then
#    echo "-----> Downloading GeoLite2-Country database ..."
#    MAXMIND_KEY=$(cat "$BUILD_DIR/conf/maxmind.key")
#    curl -o "GeoLite2-Country.tar.gz" "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=$MAXMIND_KEY&suffix=tar.gz"
#    tar -zxf "GeoLite2-Country.tar.gz" --wildcards "GeoLite2-Country_*/GeoLite2-Country.mmdb"
#    mv GeoLite2-Country_*/GeoLite2-Country.mmdb "$BUILD_DIR/conf/"
#  fi
#fi

rm -f /app/openresty
export PATH="$OLD_PATH"
env